{
  "info": {
    "name": "07-修改密码流程",
    "description": "完整的密码修改流程：登录 → 敏感验证 → 修改密码\n\n使用账号：2765301200@qq.com / 123456\n新密码：newPassword123\n\n说明：\n1. 必须先使用密码或验证码完成登录\n2. 登录后需要进行敏感操作验证（使用旧密码或邮箱验证码）\n3. 敏感验证成功后，在15分钟内提交新密码\n4. 密码修改成功后，现有登录会话继续有效\n5. 如需强制所有设备退出，请使用 /auth/logout-all\n\n环境变量：\n- accessToken: 访问令牌（登录后自动保存）\n- sensitiveCode: 敏感操作验证码（手动设置）\n- newPassword: 新密码（默认：newPassword123）",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. 登录获取 AccessToken",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const data = pm.response.json().data;",
              "    pm.environment.set('accessToken', data.accessToken);",
              "    console.log('✓ 登录成功！AccessToken 已保存');",
              "    console.log('RefreshToken 已保存在 Cookie 中');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"2765301200@qq.com\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "login"]
        }
      }
    },
    {
      "name": "2. 检查验证状态（修改前）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const data = pm.response.json().data;",
              "    console.log('✓ 当前验证状态：');",
              "    console.log('已验证: ' + data.verified);",
              "    if (data.verified) {",
              "        console.log('剩余时间: ' + data.remainingSeconds + '秒');",
              "    }",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          }
        ],
        "url": {
          "raw": "http://localhost:8000/auth/check-sensitive-verification",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "check-sensitive-verification"]
        }
      }
    },
    {
      "name": "3-A. 使用旧密码验证（敏感操作）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('✓ 敏感操作验证成功！');",
              "    console.log('验证方式: 密码验证');",
              "    console.log('验证状态有效期: 15分钟');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"method\": \"password\",\n  \"password\": \"123456\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/verify-sensitive",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "verify-sensitive"]
        }
      }
    },
    {
      "name": "3-B-1. 发送敏感操作验证码（邮箱）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('✓ 验证码已发送到绑定邮箱');",
              "    console.log('请查收邮件并将验证码设置到环境变量 sensitiveCode');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"type\": \"sensitive-verification\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/send-code",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "send-code"]
        }
      }
    },
    {
      "name": "3-B-2. 使用邮箱验证码验证（敏感操作）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('✓ 敏感操作验证成功！');",
              "    console.log('验证方式: 邮箱验证码');",
              "    console.log('旧邮箱的所有锁定限制已清除');",
              "    console.log('验证状态有效期: 15分钟');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"method\": \"email-code\",\n  \"code\": \"{{sensitiveCode}}\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/verify-sensitive",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "verify-sensitive"]
        }
      }
    },
    {
      "name": "4. 检查验证状态（验证后）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const data = pm.response.json().data;",
              "    console.log('✓ 验证状态已更新：');",
              "    console.log('已验证: ' + data.verified);",
              "    if (data.verified) {",
              "        console.log('剩余时间: ' + data.remainingSeconds + '秒');",
              "        console.log('可以进行敏感操作（修改密码）');",
              "    }",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          }
        ],
        "url": {
          "raw": "http://localhost:8000/auth/check-sensitive-verification",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "check-sensitive-verification"]
        }
      }
    },
    {
      "name": "5. 修改密码",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('✓ 密码修改成功！');",
              "    console.log('旧密码: 123456');",
              "    console.log('新密码: newPassword123');",
              "    console.log('');",
              "    console.log('注意：');",
              "    console.log('- 现有登录会话继续有效');",
              "    console.log('- 敏感操作验证状态已清除');",
              "    console.log('- 如需强制所有设备退出，请使用 /auth/logout-all');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"newPassword\": \"newPassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/update/password",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "update", "password"]
        }
      }
    },
    {
      "name": "6. 验证新密码可以登录",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const data = pm.response.json().data;",
              "    console.log('✓ 使用新密码登录成功！');",
              "    console.log('新密码已生效');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"2765301200@qq.com\",\n  \"password\": \"newPassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/login",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "login"]
        }
      }
    },
    {
      "name": "7. 改回原密码-验证（可选）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('✓ 使用新密码验证成功');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"method\": \"password\",\n  \"password\": \"newPassword123\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/verify-sensitive",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "verify-sensitive"]
        }
      }
    },
    {
      "name": "8. 改回原密码（可选）",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    console.log('✓ 密码已恢复为 123456');",
              "    console.log('测试完成！');",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{accessToken}}"
          },
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"newPassword\": \"123456\"\n}"
        },
        "url": {
          "raw": "http://localhost:8000/auth/update/password",
          "protocol": "http",
          "host": ["localhost"],
          "port": "8000",
          "path": ["auth", "update", "password"]
        }
      }
    }
  ]
}
